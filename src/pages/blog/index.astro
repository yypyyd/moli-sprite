---
import { Image } from 'astro:assets';
import { getCollection } from 'astro:content';
import BaseHead from '../../components/BaseHead.astro';
import Footer from '../../components/Footer.astro';
import FormattedDate from '../../components/FormattedDate.astro';
import Header from '../../components/Header.astro';
import { SITE_DESCRIPTION, SITE_TITLE } from '../../consts';

const posts = (await getCollection('blog')).sort(
	(a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf(),
);

const base = import.meta.env.BASE_URL;
const withBase = (path: string) => `${base.replace(/\/$/, '')}/${path.replace(/^\//, '')}`;

const groups = new Map<string, typeof posts>();
for (const post of posts) {
	const group = post.id.includes('/') ? post.id.split('/')[0] : '默认';
	const list = groups.get(group) || [];
	list.push(post);
	groups.set(group, list);
}
---

<!doctype html>
<html lang="zh-CN">
	<head>
		<BaseHead title={SITE_TITLE} description={SITE_DESCRIPTION} />
		<style>
			main { width: 960px; }
			.group-nav { display:flex; gap:.8rem; flex-wrap:wrap; margin:0 0 1rem 0; }
			.group-nav a { text-decoration:none; padding:.35rem .7rem; border:1px solid rgb(var(--gray-light)); border-radius:999px; }
			.group { margin: 1.2rem 0 2rem; }
			.group h2 { margin-bottom: .8rem; font-size: 1.2rem; }
			ul { display:flex; flex-wrap:wrap; gap:1.2rem; list-style:none; margin:0; padding:0; }
			li { width: calc(50% - .6rem); }
			li a { text-decoration:none; display:block; }
			li img { border-radius:12px; margin-bottom:.4rem; }
			.title { margin:0; color: rgb(var(--black)); }
			.date { margin:0; color: rgb(var(--gray)); }
			@media (max-width: 720px) { li { width:100%; } }
		</style>
	</head>
	<body>
		<Header />
		<main>
			<div class="group-nav">
				{Array.from(groups.keys()).map((g) => <a href={`#group-${g}`}>{g}</a>)}
				<a href={withBase('/blog/discord/')}>Discord 专组</a>
			</div>
			{
				Array.from(groups.entries()).map(([group, items]) => (
					<section class="group" id={`group-${group}`}>
						<h2>{group}</h2>
						<ul>
							{items.map((post) => (
								<li>
									<a href={withBase(`/blog/${post.id}/`)}>
										{post.data.heroImage && <Image width={720} height={360} src={post.data.heroImage} alt="" />}
										<h4 class="title">{post.data.title}</h4>
										<p class="date"><FormattedDate date={post.data.pubDate} /></p>
									</a>
								</li>
							))}
						</ul>
					</section>
				))
			}
		</main>
		<Footer />
	</body>
</html>
